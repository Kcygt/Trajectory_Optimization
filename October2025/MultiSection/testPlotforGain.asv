%% plot_cartesian_all_planes_minDist_rmse_final_withTargetPlaneColors_shiftedXZ.m
clear; clc; close all

%% ---------------- Load data ----------------
S  = load('Sdata2.mat');
P2 = load('Pdata2.mat');
P3 = load('Pdata3.mat');
P4 = load('Pdata4.mat');
P5 = load('Pdata5.mat');

ttimes = S.optimalTimes;
tfinal = S.optimalTimes(3);
tOpt   = S.tOpt;

% Actual joints
qS  = S.yOpt(:,1:3);
qP2 = P2.Pdata(:,7:9);
qP3 = P3.Pdata(:,7:9);
qP4 = P4.Pdata4(:,7:9);
qP5 = P5.Pdata5(:,7:9);

qdS  = S.yOpt(:,4:6);
qdP2 = P2.Pdata(:,10:12);
qdP3 = P3.Pdata(:,10:12);
qdP4 = P4.Pdata4(:,10:12);
qdP5 = P5.Pdata5(:,10:12);

%% ---------------- Targets ----------------
xTarget = [];
if isfield(S,'xTarget'), xTarget = S.xTarget; end
if isempty(xTarget), xTarget = [0.02 0.06 0.06; 0.03 0.05 0.07]; end % two targets example
if size(xTarget,2) ~= 3, xTarget = xTarget(:).'; end

startPt = [0 0 0];

%% ---------------- Forward Kinematics ----------------
l1 = 0.208; l2 = 0.168;
FK = @(q) [ ...
    sin(q(:,1)).*(l1*cos(q(:,2)) + l2*sin(q(:,3))), ...
    l2 - l2*cos(q(:,3)) + l1*sin(q(:,2)), ...
    -l1 + cos(q(:,1)).*(l1*cos(q(:,2)) + l2*sin(q(:,3))) ];

XYZ_S  = FK(qS);
XYZ_P2 = FK(qP2);
XYZ_P3 = FK(qP3);
XYZ_P4 = FK(qP4);
XYZ_P5 = FK(qP5);

% Final point
if isfield(S,'xFinal') && numel(S.xFinal)>=3
    xFinal = S.xFinal(1,1:3);
else
    xFinal = XYZ_S(end,:);
end

%% ---------------- Colors & bundles ----------------
col_p2  = [0.00 0.80 0.00];  % green
col_p3  = [1.00 0.50 0.00];  % orange
col_p4  = [0.70 0.00 0.70];  % purple
col_p5  = [0.10 0.10 0.10];  % black

names  = {'Hardware','1.5x','2x','4x'};
colors = {col_p2, col_p3, col_p4, col_p5};
trajs  = {XYZ_P2, XYZ_P3, XYZ_P4, XYZ_P5};

%% ---------------- 3D: trajectories + planes + shadows ----------------
fig = figure('Name','Cartesian Trajectories + Planes + Targets + RMSE');
set(fig, 'defaultTextInterpreter','latex');
set(fig, 'defaultAxesTickLabelInterpreter','latex');
set(fig, 'defaultLegendInterpreter','latex');

hold on; grid on; axis equal; view(45,25);

% Plot 3D trajectories
for i = 1:numel(trajs)
    plot3(trajs{i}(:,1),trajs{i}(:,2),trajs{i}(:,3),'-','Color',colors{i},'LineWidth',2.0,'DisplayName',names{i});
end

% Start and Final
plot3(startPt(1),startPt(2),startPt(3),'o','MarkerSize',10,'MarkerFaceColor','b','MarkerEdgeColor','k','DisplayName','Start');
plot3(xFinal(1),xFinal(2),xFinal(3),'s','MarkerSize',10,'MarkerFaceColor','r','MarkerEdgeColor','k','DisplayName','Final');

% Limits (+pad)
allXYZ = vertcat(XYZ_P2,XYZ_P3,XYZ_P4,XYZ_P5, startPt, xFinal, xTarget);
xlim_ = [min(allXYZ(:,1)), max(allXYZ(:,1))];
ylim_ = [min(allXYZ(:,2)), max(allXYZ(:,2))];
zlim_ = [min(allXYZ(:,3)), max(allXYZ(:,3))];
pad = 0.02 * max([range(xlim_), range(ylim_), range(zlim_)]);
xlim_ = xlim_ + [-pad pad];
ylim_ = ylim_ + [-pad pad];
zlim_ = zlim_ + [-pad pad];

% Shifted XZ plane location
y_xz = ylim_(1) + 0.1;
ylim_ = [min(ylim_(1), y_xz), max(ylim_(2), y_xz)];

% 3D planes without face color
[Xp, Yp] = meshgrid(linspace(xlim_(1),xlim_(2),2), linspace(ylim_(1),ylim_(2),2));
Zp = zlim_(1)*ones(size(Xp));
surf(Xp, Yp, Zp, 'FaceAlpha',0, 'EdgeColor','none', 'HandleVisibility','off'); % XY
[Xp, Zp] = meshgrid(linspace(xlim_(1),xlim_(2),2), linspace(zlim_(1),zlim_(2),2));
Yp = y_xz*ones(size(Xp));
surf(Xp, Yp, Zp, 'FaceAlpha',0, 'EdgeColor','none', 'HandleVisibility','off'); % XZ
[Yp, Zp] = meshgrid(linspace(ylim_(1),ylim_(2),2), linspace(zlim_(1),zlim_(2),2));
Xp = xlim_(1)*ones(size(Yp));
surf(Xp, Yp, Zp, 'FaceAlpha',0, 'EdgeColor','none', 'HandleVisibility','off'); % YZ

% Shadows
light = 0.55;
sh_cols = cellfun(@(c) lighten(c, light), colors, 'UniformOutput', false);
for i = 1:numel(trajs)
    XYZ = trajs{i};
    plot3(XYZ(:,1), XYZ(:,2), zlim_(1)*ones(size(XYZ,1),1), '-', ...
        'Color', sh_cols{i}, 'LineWidth', 1.4, 'HandleVisibility','off'); % XY
    plot3(XYZ(:,1), y_xz*ones(size(XYZ,1),1), XYZ(:,3), '-', ...
        'Color', sh_cols{i}, 'LineWidth', 1.4, 'HandleVisibility','off'); % XZ
    plot3(xlim_(1)*ones(size(XYZ,1),1), XYZ(:,2), XYZ(:,3), '-', ...
        'Color', sh_cols{i}, 'LineWidth', 1.4, 'HandleVisibility','off'); % YZ
end

% Targets and projections
for k = 1:size(xTarget,1)
    if k == 2
        faceColor = [0.5 0.5 0.5]; % grey
        projColor = [0.5 0.5 0.5];
    else
        faceColor = [0 0 0];       % black
        projColor = [0 0 0];
    end
    
    % 3D target marker
    plot3(xTarget(k,1), xTarget(k,2), xTarget(k,3), 'p', 'MarkerSize', 13, ...
          'MarkerFaceColor', faceColor, 'MarkerEdgeColor', 'k', 'DisplayName', sprintf('Target %d', k));
    
    % Projections on planes
    t = xTarget(k,:);
    plot3(t(1), t(2), zlim_(1), 'p', 'MarkerSize', 9, ...
        'MarkerFaceColor', projColor, 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % XY
    plot3(t(1), y_xz, t(3), 'p', 'MarkerSize', 9, ...
        'MarkerFaceColor', projColor, 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % XZ
    plot3(xlim_(1), t(2), t(3), 'p', 'MarkerSize', 9, ...
        'MarkerFaceColor', projColor, 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % YZ
end

% ---------------- Final point projections on planes ----------------
plot3(xFinal(1), xFinal(2), zlim_(1), 's', 'MarkerSize', 9, ...
      'MarkerFaceColor', 'r', 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % XY plane
plot3(xFinal(1), y_xz, xFinal(3), 's', 'MarkerSize', 9, ...
      'MarkerFaceColor', 'r', 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % XZ plane
plot3(xlim_(1), xFinal(2), xFinal(3), 's', 'MarkerSize', 9, ...
      'MarkerFaceColor', 'r', 'MarkerEdgeColor', 'k', 'HandleVisibility','off'); % YZ plane

xlabel('X (m)'); ylabel('Y (m)'); zlabel('Z (m)');
title('Cartesian Trajectories with Projection Planes');
legend('Location','bestoutside');
xlim(xlim_); ylim(ylim_); zlim(zlim_);






%% ---------------- Joint Positions ----------------
fig_q = figure('Name','Joint Positions');
set(fig_q, 'defaultTextInterpreter','latex');
set(fig_q, 'defaultAxesTickLabelInterpreter','latex');
set(fig_q, 'defaultLegendInterpreter','latex');
hold on; grid on;

timeVec = tOpt; % assuming this is your time vector

jointNames = {'q_1','q_2','q_3'};
traj_joints = {qP2, qP3, qP4, qP5};
traj_colors = colors;
traj_labels = names;

for i = 1:numel(traj_joints)
    timeVec = linspace(0,tOpt)
    plot(timeVec, traj_joints{i}(:,1), '-', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - q1']);
    plot(timeVec, traj_joints{i}(:,2), '--', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - q2']);
    plot(timeVec, traj_joints{i}(:,3), ':', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - q3']);
end

xlabel('Time (s)'); ylabel('Joint Position (rad)');
title('Joint Positions vs Time');
legend('Location','bestoutside');

%% ---------------- Joint Velocities ----------------
fig_qd = figure('Name','Joint Velocities');
set(fig_qd, 'defaultTextInterpreter','latex');
set(fig_qd, 'defaultAxesTickLabelInterpreter','latex');
set(fig_qd, 'defaultLegendInterpreter','latex');
hold on; grid on;

traj_vels = {qdP2, qdP3, qdP4, qdP5};

for i = 1:numel(traj_vels)
    plot(timeVec, traj_vels{i}(:,1), '-', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - qd1']);
    plot(timeVec, traj_vels{i}(:,2), '--', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - qd2']);
    plot(timeVec, traj_vels{i}(:,3), ':', 'Color', traj_colors{i}, 'LineWidth', 1.5, 'DisplayName', [traj_labels{i} ' - qd3']);
end

xlabel('Time (s)'); ylabel('Joint Velocity (rad/s)');
title('Joint Velocities vs Time');
legend('Location','bestoutside');






%% ---------------- Helpers ----------------
function c2 = lighten(c, amt)
    c2 = c + amt*(1 - c);
end

function XYZr = resample_equal(XYZ, N)
    n = size(XYZ,1);
    if n == N, XYZr = XYZ; return; end
    s  = linspace(1, n, n).';
    sr = linspace(1, n, N).';
    XYZr = interp1(s, XYZ, sr, 'linear');
end

