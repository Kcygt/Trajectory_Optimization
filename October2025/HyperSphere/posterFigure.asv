% process_and_plot_3D_only.m
clear; clc; close all;

%% --- dataset index ---
i = 5;
Pfile = sprintf('Pdata%d.mat', i);
Sfile = sprintf('Sdata%d.mat', i);

%% --- load data ---
Pdata = load(Pfile); % expects field Pdata.Pdata
Sdata = load(Sfile); % expects fields yOpt, tOpt, xTarget, Opt

%% --- extract data ---
PqAct  = Pdata.Pdata(:,7:9);
SqDes  = Sdata.yOpt(:,1:3);
SqAct  = Sdata.yOpt(:,7:9);

Stime = Sdata.tOpt;
Ptime = linspace(0, Stime(end), size(PqAct,1));

xTarget = Sdata.xTarget(1:5,:); % first 5 targets

%% --- forward kinematics ---
[SxAct,SyAct,SzAct] = FK(SqAct(:,1), SqAct(:,2), SqAct(:,3));
[PxAct,PyAct,PzAct] = FK(PqAct(:,1), PqAct(:,2), PqAct(:,3));
[SxDes, SyDes, SzDes] = FK(SqDes(:,1), SqDes(:,2), SqDes(:,3));

%% --- colors ---
colorSim     = [0 0 1]; % blue
colorPhantom = [1 0 0]; % red
colorRef     = [0 0 0]; % black
homeColor    = [0 0 0]; % black
targetColor  = [0 1 1]; % brownish
ctrlColor    = [0 1 0]; % green
sphereColor  = [0 0 1]; % blue

%% --- marker sizes ---
markerSizeDefault = 10;
markerSizeProj    = markerSizeDefault + 2; % +2 for projections

%% --- Figure 1: 3D Cartesian ---
figure('Name',sprintf('DataSet%d - 3D Cartesian',i),'Position',[100 100 1200 800]);
hold on; grid on; view(3); axis equal;
xlabel('$X$ (m)','Interpreter','latex');
ylabel('$Y$ (m)','Interpreter','latex');
zlabel('$Z$ (m)','Interpreter','latex');
title('Cartesian Space Position');

%% --- fixed axes limits ---
xlim([-0.03 0.16]);
ylim([-0.06 0.03]);
zlim([-0.03 0.05]);

%% --- define planes for projections ---
zLimits = zlim;       
yLimits = ylim;       
planes.z = zLimits(1);  
planes.y = yLimits(2);  

%% --- plot Home position ---
h = gobjects(0); labels = {};
homePos = [0 0 0];
h(end+1) = plot3(homePos(1), homePos(2), homePos(3), 'o', ...
    'MarkerFaceColor',homeColor,'MarkerEdgeColor','k','MarkerSize',markerSizeDefault);
labels{end+1} = 'Home';

% projections of Home
plot3(homePos(1), homePos(2), planes.z, 'o', 'MarkerSize', markerSizeProj, ...
    'MarkerFaceColor',[0.6 0.6 0.6],'MarkerEdgeColor','none','HandleVisibility','off'); % XY
plot3(homePos(1), planes.y, homePos(3), 'o', 'MarkerSize', markerSizeProj, ...
    'MarkerFaceColor',[0.6 0.6 0.6],'MarkerEdgeColor','none','HandleVisibility','off'); % XZ

%% --- plot trajectories ---
h(end+1) = plot3(SxAct,SyAct,SzAct,'-','LineWidth',2,'Color',colorSim);    labels{end+1} = 'Simulation';
h(end+1) = plot3(PxAct,PyAct,PzAct,'-','LineWidth',2,'Color',colorPhantom); labels{end+1} = 'Phantom';
h(end+1) = plot3(SxDes,SyDes,SzDes,'--','LineWidth',2,'Color',colorRef); labels{end+1} = 'Reference';

%% --- plot target points (all 5) ---
for k = 1:5
    hTarget(k) = plot3(xTarget(k,1), xTarget(k,2), xTarget(k,3), ...
        'p','MarkerSize',12,'MarkerFaceColor',targetColor,'MarkerEdgeColor',targetColor);
end
h(end+1) = hTarget(1); 
labels{end+1} = 'Targets';

%% --- plot control points and spheres ---
ctrlPts = Sdata.Opt(end-8:end);  
ctrlPts1 = ctrlPts(1:3);
ctrlPts2 = ctrlPts(4:6);
ctrlPts3 = ctrlPts(7:9);

ctrlCenters = {ctrlPts1, ctrlPts2, ctrlPts3};
radii = [0.0132, 0.005, 0.0112];  

hCtrl = []; % handle for legend
for k = 1:3
    % control point diamond
    hTmp = plot3(ctrlCenters{k}(1), ctrlCenters{k}(2), ctrlCenters{k}(3), ...
        'd','MarkerFaceColor',ctrlColor,'MarkerEdgeColor',ctrlColor,'MarkerSize',markerSizeProj);
    if k == 1
        hCtrl = hTmp;
    end
    
    % sphere
    [sx, sy, sz] = sphere(30);
    xSphere = sx * radii(k) + ctrlCenters{k}(1);
    ySphere = sy * radii(k) + ctrlCenters{k}(2);
    zSphere = sz * radii(k) + ctrlCenters{k}(3);
    surf(xSphere, ySphere, zSphere, ...
        'FaceColor', sphereColor, 'FaceAlpha', 0.3, 'EdgeColor', 'none');
    
    % projections of control points
    plot3(ctrlCenters{k}(1), ctrlCenters{k}(2), planes.z, 'd', ...
        'MarkerFaceColor', [0.6 0.6 0.6], 'MarkerEdgeColor', 'none', ...
        'MarkerSize', markerSizeProj, 'HandleVisibility','off'); % XY
    plot3(ctrlCenters{k}(1), planes.y, ctrlCenters{k}(3), 'd', ...
        'MarkerFaceColor', [0.6 0.6 0.6], 'MarkerEdgeColor', 'none', ...
        'MarkerSize', markerSizeProj, 'HandleVisibility','off'); % XZ
    
    % projections of spheres
    surf(sx*radii(k)+ctrlCenters{k}(1), ...
         sy*radii(k)+ctrlCenters{k}(2), ...
         planes.z*ones(size(sz)), ...
         'FaceColor', sphereColor, 'FaceAlpha', 0.1, 'EdgeColor', 'none', 'HandleVisibility','off'); % XY
    surf(sx*radii(k)+ctrlCenters{k}(1), ...
         planes.y*ones(size(sy)), ...
         sz*radii(k)+ctrlCenters{k}(3), ...
         'FaceColor', sphereColor, 'FaceAlpha', 0.1, 'EdgeColor', 'none', 'HandleVisibility','off'); % XZ
end
h(end+1) = hCtrl;
labels{end+1} = 'Control Points';

%% --- projections (XY and XZ only) ---
% Simulation
plot3(SxAct, SyAct, planes.z*ones(size(SzAct)), ':','LineWidth',1.2,'Color',colorSim,'HandleVisibility','off'); % XY
plot3(SxAct, planes.y*ones(size(SyAct)), SzAct, ':','LineWidth',1.2,'Color',colorSim,'HandleVisibility','off'); % XZ

% Phantom
plot3(PxAct, PyAct, planes.z*ones(size(PzAct)), ':','LineWidth',1.2,'Color',colorPhantom,'HandleVisibility','off'); % XY
plot3(PxAct, planes.y*ones(size(PyAct)), PzAct, ':','LineWidth',1.2,'Color',colorPhantom,'HandleVisibility','off'); % XZ

% Reference
plot3(SxDes, SyDes, planes.z*ones(size(SzDes)), ':','LineWidth',1.2,'Color',colorRef,'HandleVisibility','off'); % XY
plot3(SxDes, planes.y*ones(size(SyDes)), SzDes, ':','LineWidth',1.2,'Color',colorRef,'HandleVisibility','off'); % XZ

% Targets projections (+2 size)
for k = 1:5
    xt = xTarget(k,:);
    plot3(xt(1), xt(2), planes.z,'p','MarkerSize',markerSizeProj,'MarkerFaceColor',[0.6 0.6 0.6], ...
        'MarkerEdgeColor','none','HandleVisibility','off'); % XY
    plot3(xt(1), planes.y, xt(3),'p','MarkerSize',markerSizeProj,'MarkerFaceColor',[0.6 0.6 0.6], ...
        'MarkerEdgeColor','none','HandleVisibility','off'); % XZ
end

%% --- legend ---
legend(h, labels, 'Location', 'eastoutside');
hold off;
rotate3d on;
disp('Adjust the view using the mouse. Press Enter in the Command Window when ready to save.');
pause; % wa
exportgraphics(gcf, sprintf('DataSet%d_3D_plot.png', i), 'Resolution', 1000);
disp('Figure saved as PNG.');